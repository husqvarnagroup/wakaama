#!/usr/bin/env bash
set -u
set -e

SCRIPT_PATH="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"
echo "Running script: ${SCRIPT_PATH}"

echo Running @WAKAAMA_TEST_SERVER_EXECUTABLE@
@WAKAAMA_TEST_SERVER_EXECUTABLE@ &
pid=$!


function kill_wakaama_test_server()
{
    kill -9 $pid &> /dev/null || true
}

trap kill_wakaama_test_server EXIT

echo Running Leshan client tests
cd "@CMAKE_CURRENT_LIST_DIR@/../leshan_test_client"
./gradlew --no-daemon clean test -i

set +e
kill $pid

echo Done running @WAKAAMA_TEST_SERVER_EXECUTABLE@
